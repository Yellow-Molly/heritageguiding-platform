# Phase 01: CMS Collection Update + Migration

## Context Links

- Current guides collection: `packages/cms/collections/guides.ts`
- Categories collection (for specializations): `packages/cms/collections/categories.ts`
- Cities collection (for operatingAreas): `packages/cms/collections/cities.ts`
- Collections barrel: `packages/cms/collections/index.ts`

## Overview

- **Priority:** P1 (blocks all subsequent phases)
- **Status:** Pending
- **Estimate:** 1h
- **Description:** Add 5 new fields to the existing Guides collection and run database migration

## Key Insights

- Guides collection already has: name, slug, bio, credentials, photo, email, languages (6 options: sv/en/de/fr/es/it)
- Categories and Cities collections already exist with slug+index fields -- perfect for relationship fields
- The `isAdmin` access control and `formatSlugHook` are already imported
- Existing `languages` field covers main tour languages; new `additionalLanguages` extends to less common ones

## Requirements

### Functional
- Add `specializations` field: relationship to categories, hasMany, indexed
- Add `operatingAreas` field: relationship to cities, hasMany, indexed
- Add `status` field: select (active/inactive/on-leave), required, default active, sidebar
- Add `additionalLanguages` field: select hasMany with extended language options
- Add `phone` field: text, sidebar, admin-only (like email)
- Update admin `defaultColumns` to include `status`

### Non-Functional
- Migration must run clean on existing data (all new fields optional or have defaults)
- No breaking changes to existing guide data

## Architecture

No new files. Single file update + auto-generated migration.

```
packages/cms/collections/guides.ts   <- UPDATE
migrations/XXXXXXXX_XXXXXX.ts        <- AUTO-GENERATED by Payload
```

## Related Code Files

### Files to Modify
- `packages/cms/collections/guides.ts` -- add 5 new fields, update defaultColumns

### Files Created (auto)
- `apps/web/migrations/XXXXXXXX_XXXXXX.ts` -- Payload auto-generates

## Implementation Steps

1. Open `packages/cms/collections/guides.ts`
2. Add `status` field after `slug`:
   ```typescript
   {
     name: 'status',
     type: 'select',
     required: true,
     defaultValue: 'active',
     options: [
       { label: 'Active', value: 'active' },
       { label: 'Inactive', value: 'inactive' },
       { label: 'On Leave', value: 'on-leave' },
     ],
     admin: {
       position: 'sidebar',
       description: 'Guide availability status',
     },
   }
   ```
3. Add `phone` field after `email`:
   ```typescript
   {
     name: 'phone',
     type: 'text',
     maxLength: 20,
     admin: {
       description: 'Contact phone (not exposed publicly)',
       position: 'sidebar',
     },
   }
   ```
4. Add `specializations` field after `languages`:
   ```typescript
   {
     name: 'specializations',
     type: 'relationship',
     relationTo: 'categories',
     hasMany: true,
     index: true,
     admin: {
       description: 'Tour categories this guide specializes in (e.g., History, Architecture)',
     },
   }
   ```
5. Add `operatingAreas` field after `specializations`:
   ```typescript
   {
     name: 'operatingAreas',
     type: 'relationship',
     relationTo: 'cities',
     hasMany: true,
     index: true,
     admin: {
       description: 'Cities where this guide operates',
     },
   }
   ```
6. Add `additionalLanguages` field after `operatingAreas`:
   ```typescript
   {
     name: 'additionalLanguages',
     type: 'select',
     hasMany: true,
     options: [
       { label: 'Japanese', value: 'ja' },
       { label: 'Chinese', value: 'zh' },
       { label: 'Norwegian', value: 'no' },
       { label: 'Danish', value: 'da' },
       { label: 'Finnish', value: 'fi' },
       { label: 'Dutch', value: 'nl' },
       { label: 'Portuguese', value: 'pt' },
       { label: 'Russian', value: 'ru' },
       { label: 'Arabic', value: 'ar' },
       { label: 'Korean', value: 'ko' },
       { label: 'Polish', value: 'pl' },
       { label: 'Thai', value: 'th' },
       { label: 'Hindi', value: 'hi' },
     ],
     admin: {
       description: 'Additional languages beyond main tour languages',
     },
   }
   ```
7. Update `defaultColumns` to: `['name', 'status', 'languages', 'email']`
8. Run `npx payload migrate:create` to generate migration
9. Run migration: `npx payload migrate`
10. Verify in Payload admin that new fields appear correctly

## Todo List

- [ ] Add status field (select: active/inactive/on-leave)
- [ ] Add phone field (text, sidebar, admin-only)
- [ ] Add specializations field (relationship to categories)
- [ ] Add operatingAreas field (relationship to cities)
- [ ] Add additionalLanguages field (select hasMany)
- [ ] Update defaultColumns
- [ ] Generate migration
- [ ] Run migration
- [ ] Verify in CMS admin

## Success Criteria

- All 5 new fields visible in Payload admin guide form
- Status field shows in sidebar with "Active" default
- Specializations dropdown populated from categories collection
- Operating areas dropdown populated from cities collection
- Migration runs without errors on existing data
- Existing guide records unaffected (new fields null/default)

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Migration fails on production data | Medium | All new fields optional or have defaults |
| Relationship fields create N+1 queries | Low | Use depth parameter in queries |

## Security Considerations

- `phone` field admin-only (same pattern as existing `email`)
- No public read exposure of phone/email -- enforced at API layer (Phase 02)

## Next Steps

- Phase 02 depends on these fields existing for type definitions
