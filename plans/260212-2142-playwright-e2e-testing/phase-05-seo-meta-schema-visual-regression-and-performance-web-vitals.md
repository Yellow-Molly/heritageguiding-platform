# Phase 05: SEO Meta/Schema + Visual Regression + Performance Web Vitals

## Context Links
- **Parent Plan**: [plan.md](./plan.md)
- **Depends On**: [Phase 01](./phase-01-foundation-setup-config-pom-base-smoke-tests.md), [Phase 02](./phase-02-customer-journey-browse-search-filter-booking.md)
- **Research**: [i18n, Bokun, SEO, Performance](./research/researcher-02-i18n-bokun-seo-testing.md)
- **Codebase**: apps/web/components/seo/ (faq-schema, travel-agency-schema, tour-schema)

## Overview
- **Date**: 2026-02-12
- **Priority**: MEDIUM
- **Effort**: 2.5h
- **Implementation Status**: Pending
- **Review Status**: Not started

Test SEO meta tags (title, description, OpenGraph, Twitter Card) and JSON-LD structured data (TravelAgency, TourProduct/TouristAttraction, FAQPage) across key pages. Visual regression via `toHaveScreenshot()` at 3 viewports (375px mobile, 768px tablet, 1920px desktop). Performance via Core Web Vitals assertions (LCP < 2.5s, CLS < 0.1, FCP < 1.8s). WhatsApp floating button visibility and localStorage dismiss.

## Key Insights
- SEO components: `faq-schema.tsx`, `travel-agency-schema.tsx`, `tour-schema.tsx`
- JSON-LD rendered as `<script type="application/ld+json">` in page head
- Homepage uses TravelAgency schema, tour detail uses TouristAttraction, FAQ uses FAQPage
- OpenGraph tags: og:title, og:description, og:image, og:url
- Visual regression uses `toHaveScreenshot()` with `maxDiffPixels: 100`, `threshold: 0.2`
- Animations must be disabled for consistent screenshots
- Core Web Vitals measured via PerformanceObserver API
- WhatsApp button uses localStorage key `hg-whatsapp-dismissed` (from component source)
- WhatsApp link format: `https://wa.me/{phoneNumber}?text={encodedMessage}`

## Requirements

### Functional
- **SEO Meta**: Verify title, meta description (50-160 chars), og:title, og:image, og:url, twitter:card on homepage, tour catalog, tour detail
- **JSON-LD**: Parse and validate TravelAgency schema on homepage, TouristAttraction on tour detail, FAQPage on /faq
- **Visual Regression**: Capture full-page screenshots at 3 viewports for homepage, tours, tour detail, about-us
- **Performance**: Assert LCP < 2.5s, CLS < 0.1, FCP < 1.8s on homepage and tour detail
- **WhatsApp**: Button visible on page load, wa.me link with correct format, dismiss stores `hg-whatsapp-dismissed` in localStorage, reload hides button after dismiss

### Non-Functional
- Visual baselines stored per browser in `e2e/tests/visual/` (auto-generated by Playwright)
- Screenshots disable animations for deterministic comparison
- Performance thresholds are soft warnings, not hard failures (staging may be slower)
- Each spec under 200 lines

## Architecture

```
e2e/
├── tests/
│   ├── seo/
│   │   ├── meta-tags.spec.ts             # Title, description, OG, Twitter
│   │   └── schema-markup.spec.ts         # JSON-LD structured data validation
│   ├── visual/
│   │   └── visual-regression.spec.ts     # Screenshots at 3 viewports
│   ├── performance/
│   │   └── core-web-vitals.spec.ts       # LCP, CLS, FCP assertions
│   └── whatsapp/
│       └── floating-button.spec.ts       # Visibility, link, dismiss
```

## Related Code Files

### To Create
| File | Purpose |
|------|---------|
| `e2e/tests/seo/meta-tags.spec.ts` | Meta title, description, OG, Twitter Card |
| `e2e/tests/seo/schema-markup.spec.ts` | JSON-LD TravelAgency, TouristAttraction, FAQPage |
| `e2e/tests/visual/visual-regression.spec.ts` | Full-page screenshots at 3 viewports |
| `e2e/tests/performance/core-web-vitals.spec.ts` | LCP, CLS, FCP measurement |
| `e2e/tests/whatsapp/floating-button.spec.ts` | WhatsApp button + localStorage dismiss |

### Existing Reference (apps/web)
| File | Relevance |
|------|-----------|
| `components/seo/faq-schema.tsx` | FAQPage JSON-LD structure |
| `components/seo/travel-agency-schema.tsx` | TravelAgency JSON-LD structure |
| `components/seo/tour-schema.tsx` | TouristAttraction JSON-LD structure |
| `lib/seo.ts` | SEO utilities, hreflang generation |
| `components/shared/whatsapp-floating-button.tsx` | WhatsApp button, DISMISS_KEY = 'hg-whatsapp-dismissed' |

## Implementation Steps

### 1. Create e2e/tests/seo/meta-tags.spec.ts
```typescript
import { test, expect } from '@playwright/test'
import { getFirstTourSlug } from '../../fixtures/staging-data'

const LOCALE = 'en'

test.describe('SEO - Meta Tags', () => {
  test('homepage has title and meta description', async ({ page }) => {
    await page.goto(`/${LOCALE}/`)
    const title = await page.title()
    expect(title.length).toBeGreaterThan(0)

    const description = await page.locator('meta[name="description"]').getAttribute('content')
    expect(description).toBeTruthy()
    expect(description!.length).toBeGreaterThan(50)
    expect(description!.length).toBeLessThan(160)
  })

  test('homepage has OpenGraph tags', async ({ page }) => {
    await page.goto(`/${LOCALE}/`)

    const ogTitle = await page.locator('meta[property="og:title"]').getAttribute('content')
    const ogImage = await page.locator('meta[property="og:image"]').getAttribute('content')
    const ogUrl = await page.locator('meta[property="og:url"]').getAttribute('content')

    expect(ogTitle).toBeTruthy()
    expect(ogImage).toMatch(/^https?:\/\//)
    expect(ogUrl).toBeTruthy()
  })

  test('tour catalog has meta description', async ({ page }) => {
    await page.goto(`/${LOCALE}/tours`)
    const description = await page.locator('meta[name="description"]').getAttribute('content')
    expect(description).toBeTruthy()
  })

  test('tour detail page has specific meta tags', async ({ page, browser }) => {
    const tempPage = await browser.newPage()
    const slug = await getFirstTourSlug(tempPage)
    await tempPage.close()

    await page.goto(`/${LOCALE}/tours/${slug}`)

    const title = await page.title()
    expect(title.length).toBeGreaterThan(0)

    const description = await page.locator('meta[name="description"]').getAttribute('content')
    expect(description).toBeTruthy()

    const ogTitle = await page.locator('meta[property="og:title"]').getAttribute('content')
    expect(ogTitle).toBeTruthy()

    // Twitter card
    const twitterCard = await page.locator('meta[name="twitter:card"]').getAttribute('content')
    if (twitterCard) {
      expect(twitterCard).toBe('summary_large_image')
    }
  })

  test('FAQ page has meta description', async ({ page }) => {
    await page.goto(`/${LOCALE}/faq`)
    const title = await page.title()
    expect(title.length).toBeGreaterThan(0)
  })
})
```

### 2. Create e2e/tests/seo/schema-markup.spec.ts
```typescript
import { test, expect } from '@playwright/test'
import { getFirstTourSlug } from '../../fixtures/staging-data'

const LOCALE = 'en'

/** Extract all JSON-LD scripts from page */
async function getJsonLdSchemas(page: import('@playwright/test').Page) {
  return page.locator('script[type="application/ld+json"]').evaluateAll(
    scripts => scripts.map(s => {
      try { return JSON.parse(s.textContent || '{}') }
      catch { return null }
    }).filter(Boolean)
  )
}

test.describe('SEO - JSON-LD Schema Markup', () => {
  test('homepage has TravelAgency schema', async ({ page }) => {
    await page.goto(`/${LOCALE}/`)
    const schemas = await getJsonLdSchemas(page)

    const agency = schemas.find(
      (s: Record<string, unknown>) => s['@type'] === 'TravelAgency' || s['@type'] === 'Organization'
    )
    expect(agency).toBeTruthy()
    expect(agency['@context']).toContain('schema.org')
    expect(agency.name).toBeTruthy()
  })

  test('tour detail has TouristAttraction or Product schema', async ({ page, browser }) => {
    const tempPage = await browser.newPage()
    const slug = await getFirstTourSlug(tempPage)
    await tempPage.close()

    await page.goto(`/${LOCALE}/tours/${slug}`)
    const schemas = await getJsonLdSchemas(page)

    const tourSchema = schemas.find(
      (s: Record<string, unknown>) =>
        s['@type'] === 'TouristAttraction' ||
        s['@type'] === 'Product' ||
        s['@type'] === 'TourProduct'
    )
    expect(tourSchema).toBeTruthy()
    expect(tourSchema['@context']).toContain('schema.org')
    expect(tourSchema.name).toBeTruthy()
    expect(tourSchema.description).toBeTruthy()
  })

  test('FAQ page has FAQPage schema', async ({ page }) => {
    await page.goto(`/${LOCALE}/faq`)
    const schemas = await getJsonLdSchemas(page)

    const faqSchema = schemas.find(
      (s: Record<string, unknown>) => s['@type'] === 'FAQPage'
    )
    expect(faqSchema).toBeTruthy()
    expect(faqSchema.mainEntity).toBeTruthy()
    expect(Array.isArray(faqSchema.mainEntity)).toBe(true)
    expect(faqSchema.mainEntity.length).toBeGreaterThan(0)

    // Each FAQ item should have question and answer
    const firstItem = faqSchema.mainEntity[0]
    expect(firstItem['@type']).toBe('Question')
    expect(firstItem.name).toBeTruthy()
    expect(firstItem.acceptedAnswer).toBeTruthy()
  })
})
```

### 3. Create e2e/tests/visual/visual-regression.spec.ts
```typescript
import { test, expect } from '@playwright/test'

const LOCALE = 'en'

const VIEWPORTS = [
  { name: 'mobile', width: 375, height: 812 },
  { name: 'tablet', width: 768, height: 1024 },
  { name: 'desktop', width: 1920, height: 1080 },
]

const PAGES = [
  { name: 'homepage', path: '/' },
  { name: 'tour-catalog', path: '/tours' },
  { name: 'about-us', path: '/about-us' },
  { name: 'faq', path: '/faq' },
]

test.describe('Visual Regression', () => {
  for (const viewport of VIEWPORTS) {
    for (const { name, path } of PAGES) {
      test(`${name} at ${viewport.name} (${viewport.width}px)`, async ({ page }) => {
        await page.setViewportSize({ width: viewport.width, height: viewport.height })
        await page.goto(`/${LOCALE}${path}`)
        await page.waitForLoadState('networkidle')

        await expect(page).toHaveScreenshot(
          `${name}-${viewport.name}.png`,
          {
            fullPage: true,
            animations: 'disabled',
            maxDiffPixels: 100,
            threshold: 0.2,
          }
        )
      })
    }
  }
})
```

**Note**: First run generates baseline snapshots. Update baselines with:
```bash
npx playwright test tests/visual --update-snapshots
```

### 4. Create e2e/tests/performance/core-web-vitals.spec.ts
```typescript
import { test, expect } from '@playwright/test'

const LOCALE = 'en'

interface WebVitals {
  fcp: number | null
  lcp: number | null
  cls: number | null
}

/** Measure Core Web Vitals using PerformanceObserver */
async function measureWebVitals(page: import('@playwright/test').Page): Promise<WebVitals> {
  return page.evaluate(() => {
    return new Promise<{ fcp: number | null; lcp: number | null; cls: number | null }>((resolve) => {
      let lcp: number | null = null
      let cls = 0

      // FCP from paint entries
      const fcp = performance.getEntriesByType('paint')
        .find(e => e.name === 'first-contentful-paint')?.startTime ?? null

      // LCP observer
      const lcpObserver = new PerformanceObserver((list) => {
        const entries = list.getEntries()
        const lastEntry = entries[entries.length - 1] as PerformanceEntry & { renderTime?: number; loadTime?: number }
        lcp = lastEntry.renderTime || lastEntry.loadTime || lastEntry.startTime
      })
      lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true })

      // CLS observer
      const clsObserver = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          cls += (entry as PerformanceEntry & { value?: number }).value || 0
        }
      })
      clsObserver.observe({ type: 'layout-shift', buffered: true })

      // Resolve after page settles
      setTimeout(() => {
        lcpObserver.disconnect()
        clsObserver.disconnect()
        resolve({ fcp, lcp, cls })
      }, 5000)
    })
  })
}

test.describe('Performance - Core Web Vitals', () => {
  // Use only Chromium for performance tests (consistent metrics)
  test.skip(({ browserName }) => browserName !== 'chromium', 'Performance tests run on Chromium only')

  test('homepage meets LCP, CLS, FCP thresholds', async ({ page }) => {
    await page.goto(`/${LOCALE}/`)
    const vitals = await measureWebVitals(page)

    // FCP < 1.8s
    if (vitals.fcp !== null) {
      expect(vitals.fcp).toBeLessThan(1800)
    }

    // LCP < 2.5s
    if (vitals.lcp !== null) {
      expect(vitals.lcp).toBeLessThan(2500)
    }

    // CLS < 0.1
    expect(vitals.cls).toBeLessThan(0.1)
  })

  test('tour catalog meets performance thresholds', async ({ page }) => {
    await page.goto(`/${LOCALE}/tours`)
    const vitals = await measureWebVitals(page)

    if (vitals.fcp !== null) expect(vitals.fcp).toBeLessThan(1800)
    if (vitals.lcp !== null) expect(vitals.lcp).toBeLessThan(2500)
    expect(vitals.cls).toBeLessThan(0.1)
  })

  test('page load time under 3 seconds', async ({ page }) => {
    const start = Date.now()
    await page.goto(`/${LOCALE}/`)
    await page.waitForLoadState('load')
    const loadTime = Date.now() - start

    expect(loadTime).toBeLessThan(3000)
  })
})
```

### 5. Create e2e/tests/whatsapp/floating-button.spec.ts
```typescript
import { test, expect } from '@playwright/test'

const LOCALE = 'en'
const DISMISS_KEY = 'hg-whatsapp-dismissed'

test.describe('WhatsApp Floating Button', () => {
  test.beforeEach(async ({ page }) => {
    // Clear dismiss state before each test
    await page.goto(`/${LOCALE}/`)
    await page.evaluate((key) => localStorage.removeItem(key), DISMISS_KEY)
    await page.reload()
    await page.waitForLoadState('networkidle')
  })

  test('WhatsApp button is visible on page load', async ({ page }) => {
    const waButton = page.locator('a[href*="wa.me"]')
    // Button may not appear if no phone number configured in CMS
    if (await waButton.isVisible()) {
      await expect(waButton).toBeVisible()
      const href = await waButton.getAttribute('href')
      expect(href).toMatch(/wa\.me\/\d+/)
    }
  })

  test('WhatsApp link includes locale-specific message', async ({ page }) => {
    const waButton = page.locator('a[href*="wa.me"]')
    if (await waButton.isVisible()) {
      const href = await waButton.getAttribute('href')
      expect(href).toContain('text=')
    }
  })

  test('dismiss button hides WhatsApp widget', async ({ page }) => {
    const waButton = page.locator('a[href*="wa.me"]')
    if (await waButton.isVisible()) {
      // Find and click dismiss button (X icon near the prompt)
      const dismissBtn = page.locator(`button[aria-label]`).filter({
        has: page.locator('svg')
      }).last()

      if (await dismissBtn.isVisible()) {
        await dismissBtn.click()
        await expect(waButton).not.toBeVisible()
      }
    }
  })

  test('dismiss persists in localStorage', async ({ page }) => {
    const waButton = page.locator('a[href*="wa.me"]')
    if (await waButton.isVisible()) {
      const dismissBtn = page.locator(`button[aria-label]`).filter({
        has: page.locator('svg')
      }).last()

      if (await dismissBtn.isVisible()) {
        await dismissBtn.click()

        const dismissed = await page.evaluate(
          (key) => localStorage.getItem(key),
          DISMISS_KEY
        )
        expect(dismissed).toBe('true')
      }
    }
  })

  test('widget stays hidden after reload when dismissed', async ({ page }) => {
    const waButton = page.locator('a[href*="wa.me"]')
    if (await waButton.isVisible()) {
      const dismissBtn = page.locator(`button[aria-label]`).filter({
        has: page.locator('svg')
      }).last()

      if (await dismissBtn.isVisible()) {
        await dismissBtn.click()
        await page.reload()
        await page.waitForLoadState('networkidle')
        await expect(waButton).not.toBeVisible()
      }
    }
  })
})
```

### 6. Create e2e/tests/admin/admin-smoke-test-login-page.spec.ts
```typescript
import { test, expect } from '@playwright/test'

test.describe('Admin - Smoke Test', () => {
  test('/admin loads login page', async ({ page }) => {
    const response = await page.goto('/admin')
    expect(response?.status()).toBeLessThan(400)

    // Payload CMS login form should be present
    const emailInput = page.getByLabel(/email/i)
    const passwordInput = page.getByLabel(/password/i)

    await expect(emailInput).toBeVisible()
    await expect(passwordInput).toBeVisible()
  })

  test('admin login with valid credentials', async ({ page }) => {
    const email = process.env.ADMIN_EMAIL
    const password = process.env.ADMIN_PASSWORD

    // Skip if credentials not provided
    test.skip(!email || !password, 'ADMIN_EMAIL and ADMIN_PASSWORD env vars required')

    await page.goto('/admin')
    await page.getByLabel(/email/i).fill(email!)
    await page.getByLabel(/password/i).fill(password!)
    await page.getByRole('button', { name: /log in|sign in/i }).click()

    // Should redirect to admin dashboard
    await page.waitForURL(/\/admin(?!\/login)/, { timeout: 10000 })
    await expect(page).not.toHaveURL(/login/)
  })
})
```

## Todo List
- [ ] Create `e2e/tests/seo/meta-tags.spec.ts`
- [ ] Create `e2e/tests/seo/schema-markup.spec.ts`
- [ ] Create `e2e/tests/visual/visual-regression.spec.ts`
- [ ] Create `e2e/tests/performance/core-web-vitals.spec.ts`
- [ ] Create `e2e/tests/whatsapp/floating-button.spec.ts`
- [ ] Create `e2e/tests/admin/admin-smoke-test-login-page.spec.ts`
- [ ] Generate initial visual baselines: `npx playwright test tests/visual --update-snapshots`
- [ ] Verify JSON-LD schema types match actual component output
- [ ] Verify WhatsApp dismiss key matches `DISMISS_KEY` in component source
- [ ] Run performance tests on Chromium and validate thresholds
- [ ] Run all tests against staging with 3 browsers

## Success Criteria
- Meta title + description present on homepage, catalog, tour detail, FAQ
- OpenGraph og:title, og:image, og:url on homepage and tour detail
- TravelAgency JSON-LD on homepage with name + @context
- TouristAttraction/Product JSON-LD on tour detail with name + description
- FAQPage JSON-LD on /faq with mainEntity array of Question items
- Visual screenshots captured at 375px, 768px, 1920px for 4 pages
- LCP < 2.5s, CLS < 0.1, FCP < 1.8s on homepage (Chromium)
- WhatsApp button visible, dismissable, localStorage persists dismiss
- Admin login page loads with email/password form
- Admin login succeeds with valid credentials (when env vars provided)

## Risk Assessment
| Risk | Likelihood | Mitigation |
|------|-----------|------------|
| Visual diffs from dynamic content (dates, testimonials) | High | Use `maxDiffPixels: 100`, disable animations |
| Performance thresholds too strict for staging | Medium | Use soft assertions or larger thresholds for staging |
| WhatsApp phone number not configured in staging CMS | Medium | Conditional tests with `if (await waButton.isVisible())` |
| JSON-LD schema types differ from expected | Low | Check multiple @type possibilities (TouristAttraction or Product) |
| Admin credentials not available in CI | Low | `test.skip()` when env vars missing |

## Security Considerations
- ADMIN_EMAIL, ADMIN_PASSWORD passed via env vars, never hardcoded
- Admin login test skipped when credentials not provided
- No screenshots stored of admin authenticated pages (login page only)
- Performance measurements are read-only client-side operations

## Next Steps
- Phase 06 integrates all tests into GitHub Actions CI workflow
- Visual baselines must be committed to repo after first generation
- Performance thresholds may need tuning after initial staging runs
